#!/bin/bash -e

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

set -e          # exit on command errors (so you MUST handle exit codes properly!)
set -o pipefail # capture fail exit codes in piped commands
#set -x         # execution tracing debug messages

# Get command info
CMD_PWD=$(pwd)
CMD="$0"
CMD_DIR="$(cd "$(dirname "$CMD")" && pwd -P)"

# Defaults and command line options
[ "$VERBOSE" ]  ||  VERBOSE=
[ "$DEBUG" ]    ||  DEBUG=

# Basic helpers
out() { echo "$(date +%Y%m%dT%H%M%SZ): $*"; }
err() { out "$*" 1>&2; }
vrb() { [ ! "$VERBOSE" ] || out "$@"; }
dbg() { [ ! "$DEBUG" ] || err "$@"; }
die() { err "EXIT: $1" && [ "$2" ] && [ "$2" -ge 0 ] && exit "$2" || exit 1; }
usage() { [ "$0" = "bash" ] || sed '2,/^##/p;d' "$0"; echo "$*"; exit 1; }

[ "$DEBUG" ]  &&  set -x

# Validate some things
[ "$1" = "--help" -o "$1" = "-h" ]  &&  usage ""

###############################################################################

MONGODB_HOST={{ mongodb_backup_host }}
MONGODB_PORT={{ mongodb_backup_port }}
MONGODB_USER={{ mongodb_backup_user }}
MONGODB_PASS={{ mongodb_backup_pass }}
MONGODB_DB={{ mongodb_backup_db }}
S3PATH={{ mongodb_backup_s3path }}

TIMESTAMP=`date +"%Y%m%dT%H%M%S"`
BACKUP_NAME=${TIMESTAMP}.dump.gz
S3BACKUP=${S3PATH}/${BACKUP_NAME}
S3LATEST=${S3PATH}/latest.dump.gz

EXTRA_OPTS={{ mongodb_backup_opts }}

[[ ( -z "${MONGODB_USER}" ) && ( -n "${MONGODB_PASS}" ) ]] && MONGODB_USER='admin'
[[ ( -n "${MONGODB_USER}" ) ]] && EXTRA_OPTS="$EXTRA_OPTS --username ${MONGODB_USER}"
[[ ( -n "${MONGODB_PASS}" ) ]] && EXTRA_OPTS="$EXTRA_OPTS --password ${MONGODB_PASS}"
[[ ( -n "${MONGODB_DB}" ) ]] && EXTRA_OPTS="$EXTRA_OPTS --db ${MONGODB_DB}"

cd {{ mongodb_backup_home }}

source ./aws

echo "=> Done"

case "$1" in

    backup|b)
        echo 'backup'
        ;;

    restore|r)
        echo 'restore'
        ;;

    *)
        usage "Unknown option '$1'"
        ;;

esac
